const azure = require('azure-storage');

export const uploadImage = async (
  filename: string, //file[0].file.name
  image: string, //file[0].file
): Promise<string> => {

  const blobService = azure.createBlobService(
    'DefaultEndpointsProtocol=https;AccountName=catalogv2;AccountKey=/nae0fL8Nncvylu7l4WFQjOmPp0J+uwjv6ruXIevhIkJAJiLbQWTLS7sQ5X7J5/63P0MwCULRS5xrIdsoJwuew==;EndpointSuffix=core.windows.net',
  );

  const matches = image.match(/^data:([A-Za-z-+\/]+);base64,(.+)$/);
  const imageFormat = matches![1];
  const buffer = new Buffer(matches![2], 'base64');

  await blobService.createBlockBlobFromText(
    'storage-images',
    filename,
    buffer,
    {contentType: imageFormat},
    (error: any, result: any, response: any) => {
      if (error) filename = 'default.jpg';
    },
  );

  return `${'https://catalogv2.blob.core.windows.net/storage-images'}/${filename}`;
};